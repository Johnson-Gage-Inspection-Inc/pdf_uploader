name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate date-based version tag
        id: version
        shell: pwsh
        run: |
          $date = Get-Date -Format "yyyy.MM.dd"
          # Check for existing tags with today's date
          $existing = git tag --list "$date*" | Sort-Object
          if ($existing) {
            # Find the highest suffix
            $last = ($existing | Select-Object -Last 1)
            if ($last -match "\d{4}\.\d{2}\.\d{2}\.(\d+)$") {
              $next = [int]$Matches[1] + 1
              $tag = "$date.$next"
            } else {
              $tag = "$date.2"
            }
          } else {
            $tag = $date
          }
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "Generated version tag: $tag"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Enable long paths
        run: git config --system core.longpaths true

      - name: Install dependencies and build
        run: |
          py -3.12 -m venv myenv
          .\myenv\Scripts\activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "QUALER_API_KEY=${{ secrets.QUALER_API_KEY }}" > .env
          echo "__version__ = '${{ steps.version.outputs.tag }}'" > app/version.py
          pyinstaller PDF_Uploader.spec

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdf-uploader-build
          path: dist/PDF_Uploader.exe

    outputs:
      tag: ${{ steps.version.outputs.tag }}

  release:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: pdf-uploader-build
          path: dist

      - name: Create tag and release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ needs.build.outputs.tag }}
          tag_name: ${{ needs.build.outputs.tag }}
          generate_release_notes: true
          files: dist/PDF_Uploader.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
